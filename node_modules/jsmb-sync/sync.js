var fs = require('fs');
var path = require('path');
var Util = require('jsmb-util');

module.exports = (function(){

    /**
     * 根据watch监听源文件夹文件变更，同步到指定的路径
     *
     * @param {String} src 源文件路径
     * @param {String} dst 目标文件路径
     */
    function dsync(src, dst){

        // 如果源文件不存在，则需要判断对应同步的文件同步删除
        if(!fs.existsSync(src)){
            if(fs.existsSync(dst)){
                var fileStat = fs.statSync(dst);
                if(fileStat.isDirectory()){
                    try{
                        fs.rmdirSync(dst);
                    }catch(e){}
                }else{
                    fs.unlinkSync(dst);

                    // 如果是文件，需要校验其当前文件夹是否存在，如果不存在，则需要尝试删除
                    if(!fs.existsSync(path.dirname(src))){
                        var list = fs.readdirSync(path.dirname(dst));
                        if(list.length === 0){
                            fs.rmdirSync(path.dirname(dst));
                        }
                    }
                }
            }
            return;
        }

        // 文件夹和文件区分复制
        if(fs.statSync(src).isDirectory()){
            Util.mkdir(dst);
        }else{
            // 保证复制前文件夹存在
            Util.mkdir(path.dirname(dst));
            // 复制文件
            if(fs.readFileSync(src)){
                //console.log(dst, src)
                //console.log("源文件内容为：" + fs.readFileSync(src))
                fs.writeFileSync(dst, fs.readFileSync(src));
            }else{
                console.log(src, '源文件无法读取内容');
            }

        }

    }


    // TODO 难点：实现跟rsync一样的文件同步，用nodejs性能低，采用md5校验文件，小文件还可以，大文件速度就很慢
    function rsync(src, dst, ignore){
        var cache = {};
    }


    return {
        dsync: dsync,
        rsync: rsync
    };
})();

